# Vite æ•´åˆ Electron æ€»ç»“

## å‰è¨€

- Vite æ˜¯é¢å‘æœªæ¥å‡ å¹´çš„æ„å»ºå·¥å…·ï¼Œå¾ˆæœ‰å¿…è¦åœ¨å„ä¸ªåœºæ™¯ä¸‹éƒ½è¯•è¯•é›†æˆè¿›æ¥
- Electron ä½œä¸ºå‰ç«¯æ ‡é…çš„æ¡Œé¢å¼€å‘å·¥å…· `@vue/cli` å®˜æ–¹æœ‰ç»™å‡ºæ¨¡æ¿
  ä½†æ˜¯ Vite è¿™å—å¹¶æ²¡æä¾›ï¼Œæ¯•ç«Ÿäººå®¶å®šä½æ˜¯å’Œ `webpack` é‚£æ ·çš„é€šç”¨æ„å»ºå·¥å…·ï¼Œç”šè‡³è¿ Vue éƒ½æ²¡é›†æˆ ğŸ––
  é‚£ä¹ˆ Electron è¿™å—é›†æˆè®¾è®¡æ€è·¯æŒ‰ç…§ vue çš„é›†æˆé£æ ¼ï¼Œåº”å½“å†™ä¸€ä¸ªæ’ä»¶ï¼

## æ³¨æ„ ğŸ“¢
- è¿™é‡Œå‡å®šä½ ç®€å•çš„çŸ¥é“ä¸€äº› Vite çš„å·¥ä½œåŸç†ï¼Œè¿™ç§æ–‡ç« ç½‘ä¸Šæœ‰å¥½å¤šçš„
- é¡¹ç›®æ•´ä½“æ‰€æœ‰ä»£ç åœ¨è¿™ [https://github.com/caoxiemeihao/electron-vue-vite](https://github.com/caoxiemeihao/electron-vue-vite) å¯ä»¥ç›´æ¥ **ç”¨äºç”Ÿäº§** (è¿˜è¦è¾›è‹¦å„ä½äº²ç‚¹ä¸ª start ğŸ˜˜)

## æ’ä»¶è®¾è®¡åˆ†æ

1. Vite åœ¨å¼€å‘æœŸå¯ä»¥ç®€å•çš„ç†è§£ä¸ºç”¨çš„ `koa` + `esbuild` ç»„åˆçš„å½¢å¼ï¼Œè¯•æƒ³ä¸‹å¦‚æœä½ å†™äº†å¦‚ä¸‹ä»£ç 

```ts
// src/render/main.ts
import { createApp } from 'vue'
import App from './App.vue'
import { ipcRenderer } from 'electron'

console.log('ipcRenderer:', ipcRenderer)

createApp(App)
  .mount('#app')
```
é‚£ä¹ˆå¯èƒ½ä½ ä¼šæ”¶åˆ°ä¸‹é¢çš„æŠ¥é”™

![import-electron.jpg](./images/import-electron.jpg)

2. äº‹å®ä¸Šåœ¨ `'electron'` åœ¨ Electron è¿è¡Œç¯å¢ƒä¸­æ˜¯ä¸€ä¸ª **å†…ç½®æ¨¡å—** ä½ å¯ä»¥å°è¯•åœ¨æ§åˆ¶ä½“ä¸­è¯•è¯•ä¸‹è¿™æ®µä»£ç 

> *æ³¨æ„è¿™é‡Œå…ˆä¸è¦å¼•å…¥ Electron ç›¸å…³çš„åŒ…ï¼Œä¿éšœé¡¹ç›®èƒ½è·‘èµ·æ¥*

```js
require.resolve('electron')
"electron" // å°†ä¼šè¾“å‡º
```

æ—¢ç„¶ Electron æœ¬å°±æ”¯æŒå…¨é‡çš„ NodeJs API æˆ‘ä»¬ä¸å¦¨ç›´æ¥åœ¨åœ¨ä»£ç ä¸­ç›´æ¥å†™æˆ

```js
const { ipcRenderer } = require('electron')
```

å¯ä»¥æ‰“åŒ…ç¥¨è¯´ï¼Œè¿™ä¸ªå¯ä»¥ç”¨ï¼(ä»…é™å¼€å‘æœŸ)ï¼›ä½†æ˜¯è¿™ä¸ªä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜
  * ç¼–ç é£æ ¼ä¸ç»Ÿä¸€ï¼Œäººå®¶éƒ½åœ¨ç”¨ `ESModule` æ··å…¥ `CommonJs` ç¡®å®ä¸å¥½çœ‹
  * `require('xxxx')` åœ¨æ‰“åŒ…æœŸé—´å¦‚æœä¸åšäº›å¤„ç†ï¼Œå¹¶ä¸ä¼šè¢« Rollup å¤„ç† (è¿™é‡Œåª`.ts`æ–‡ä»¶,æœ‰å¤§ç¥çŸ¥é“æ€ä¹ˆå¯¹ä»˜è¿™ç§æƒ…å†µçš„è¯·æŒ‡ç‚¹ä¸‹å°å¼Ÿ)
    å¦‚æœä½ å¼•å…¥çš„æ˜¯ `node_modules` ä¸­çš„åŒ…é‚£å¯å°±æƒ¨äº†ï¼›æ¯”å¦‚ `require('electron-store')` è¿™ç§ä¼šåŸæ ·è¾“å‡ºï¼›æ‰“åŒ…åçš„ç¨‹åºå¼€èµ·æ¥ä¼šæ‰¾ä¸åˆ° `'electron-store'` è¿™ä¸ªæ¨¡å—ï¼Œé“å®šæŠ¥é”™ï¼

3. ä»¥ä¸Šä¸¤ç‚¹è¡¨ç°äº† `ESModule` å†™æ³•åœ¨å¼€å‘æœŸç›´æ¥è¿è¡Œä¼šæŠ¥é”™ï¼›å¦‚æœæˆ‘ä»¬å‘Šè¯‰ Vite è¿™ä¸ªæ˜¯å†…ç½®çš„æ¨¡å—ï¼Œä¸è¦å»å¤„ç†ç›´å²‚ä¸æ˜¯åˆ‡è§’æŸœè§£å†³æŠ¥é”™äº†ï¼›
æ€è·¯æ˜¯æŠŠ ESModule è½¬æ¢æˆ NodeJs å†…ç½®çš„ CommonJs å½¢å¼å³å¯ï¼›ç”šè‡³åªè¦æœ‰å…³ NodeJs API çš„åŒ…æˆ‘ä»¬éƒ½å¯ä»¥è½¬åŒ–ï¼Œæ¯•ç«Ÿå¼€å‘æœŸé¡¹ç›®æ ¹ç›®å½•æ˜¯æœ‰ `node_modules` è¿™ä¸ª **NodeJsåŒ…ä»“åº“** ç»™ä½ ç”¨çš„ï¼
æˆ‘ä»¬å¯ä»¥å…ˆå»å¯åŠ¨å¥½çš„é¡¹ç›®æ§åˆ¶å°ä¸­è¯•è¯•

> *æ³¨æ„è¿™é‡Œå…ˆä¸è¦å¼•å…¥ Electron ç›¸å…³çš„åŒ…ï¼Œä¿éšœé¡¹ç›®èƒ½è·‘èµ·æ¥*

![require-electron.jpg](./images/require-electron.jpg)

**è¿™ä¸¤ä¸ªåŒ…å¼€å‘ç¯å¢ƒä¸‹èƒ½å¤Ÿæ­£å¸¸åŠ è½½ï¼**
å¾ˆå¥½ï¼é‚£æŒ‰ç…§æˆ‘ä»¬çš„å‡è®¾ï¼Œé¢„æœŸçš„ä»£ç è¡Œä¸ºåº”è¯¥æ˜¯è¿™æ ·ï¼š

```ts
import { ipcRenderer } from 'electron'
import Store from 'electron-store'
// Will generate
const { ipcRenderer } = require("electron")
const Store = require("electron-store")
```

4. åˆ†æè‡³æ­¤ï¼Œæˆ‘ä»¬è¯¥åŠ¨åŠ¨æ‰‹å†™ä¸ªæ’ä»¶äº†ï¼›è®©æ’ä»¶å»è‡ªåŠ¨åŒ–å®Œæˆ `esm2cjs`

## vitejs-plugin-electron
- Vite æ’ä»¶ä¸Šæ‰‹æ•™ç¨‹è¯·çœ‹å®˜ç½‘ [https://vitejs.dev/guide/api-plugin.html](https://vitejs.dev/guide/api-plugin.html) (æˆ‘ä¸ªäººè§‰å¾—æ¯” `webpack` é‚£è¾¹çš„æ’ä»¶è¦å¥½å†™)
- ä¸ºäº†æ”¯æŒä¼ å‚æ–¹ä¾¿æ—¥åæ‰©å±•ï¼Œæˆ‘ä»¬æŠŠå®ƒæˆä¸€ä¸ª Function å¹¶è¿”å›ä¸€ä¸ªæ’ä»¶
- ä»£ç å¤„ç†è¿™å—ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª AST å·¥å…·å¸®å¿™ - `yarn add acorn` 

```ts
import * as acorn from 'acorn'
import { Plugin as VitePlugin } from 'vite'

const extensions = ['.js', '.jsx', '.ts', '.tsx', '.vue'] // éœ€è¦å¤„ç†çš„æ–‡ä»¶åç¼€

export interface Esm2cjsOptions {
  excludes?: string[] // éœ€è¦è¢«è½¬æ¢çš„æ¨¡å—
}

export default function esm2cjs(options?: Esm2cjsOptions): VitePlugin {
  const opts: Esm2cjsOptions = {
    // é»˜è®¤æˆ‘ä»¬è½¬æ¢ electronã€electron-store ä¸¤ä¸ªæ¨¡å—
    excludes: [
      'electron',
      'electron-store',
    ],
    ...options
  }

  return {
    name: 'vitejs-plugin-electron', // è¿™ä¸ª name å°±æ˜¯æ’ä»¶åå­—
    transform(code, id) {
      const parsed = path.parse(id) // è§£æå¼•å…¥æ¨¡å—çš„è·¯å¾„ï¼Œid å³å¼•å…¥æ–‡ä»¶å®Œæ•´è·¯å¾„
      if (!extensions.includes(parsed.ext)) return // åªå¤„ç†éœ€è¦å¤„ç†çš„æ–‡ä»¶åç¼€

      const node: any = acorn.parse(code, { // ä½¿ç”¨ acorn è§£æ ESTree
        ecmaVersion: 'latest', // æŒ‡å®šæŒ‰ç…§æœ€æ–°çš„ es æ¨¡å—æ ‡å‡†è§£æ
        sourceType: 'module', // æŒ‡å®šæŒ‰ç…§æ¨¡å—è¿›è¡Œè§£æ
      })

      let codeRet = code
      node.body.reverse().forEach((item) => {
        if (item.type !== 'ImportDeclaration') return // è·³è¿‡é import è¯­å¥
        if (!opts.excludes.includes(item.source.value)) return // è·³è¿‡ä¸è¦è½¬æ¢çš„æ¨¡å—

        /**
         * ä¸‹é¢è¿™äº› const å£°æ˜ç”¨æ¥ç¡®å®š import çš„å†™æ³•
         */
        const statr = codeRet.substring(0, item.start)
        const end = codeRet.substring(item.end)
        const deft = item.specifiers.find(({ type }) => type === 'ImportDefaultSpecifier')
        const deftModule = deft ? deft.local.name : ''
        const nameAs = item.specifiers.find(({ type }) => type === 'ImportNamespaceSpecifier')
        const nameAsModule = nameAs ? nameAs.local.name : ''
        const modules = item.
          specifiers
          .filter((({ type }) => type === 'ImportSpecifier'))
          .reduce((acc, cur) => acc.concat(cur.imported.name), [])

        /**
         * è¿™é‡Œå¼€å§‹æ ¹æ®å„ç§ import è¯­æ³•åšè½¬æ¢
         */
        if (nameAsModule) {
          // import * as name from
          codeRet = `${statr}const ${nameAsModule} = require(${item.source.raw})${end}`
        } else if (deftModule && !modules.length) {
          // import name from 'mod'
          codeRet = `${statr}const ${deftModule} = require(${item.source.raw})${end}`
        } else if (deftModule && modules.length) {
          // import name, { name2, name3 } from 'mod'
          codeRet = `${statr}const ${deftModule} = require(${item.source.raw})
 const { ${modules.join(', ')} } = ${deftModule}${end}`
        } else {
          // import { name1, name2 } from 'mod'
          codeRet = `${statr}const { ${modules.join(', ')} } = require(${item.source.raw})${end}`
        }
      })

      return codeRet
    },
  }
}

```

- åœ¨ `vite.config.ts` ä¸­ä½¿ç”¨ `vitejs-plugin-electron`

```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import electron from 'vitejs-plugin-electron'

export default defineConfig((env) => ({
  plugins: [
    vue(),
    electron(),
  ],
  // å…¶ä»–é…ç½®ç•¥...
}))
```

- å†æ¬¡è¿è¡Œä¸‹é¡¹ç›®
![plugin-electron.jpg](./images/plugin-electron.jpg)

- **It's Workedï¼** ğŸ‰ ğŸ‰ ğŸ‰ 

- ç»†å¿ƒçš„ç«¥é‹å¯èƒ½å‘ç°äº†æˆ‘ä»¬çš„ä»£ç ä¸Šé¢è¿˜æœ‰ä¸€è¡Œ

```js
const fs = require("fs");
```

çœ‹åˆ°è¿™ä¸ªæˆ‘**æœ‰ç‚¹æ‡µ**ï¼Œæˆ‘ä¹Ÿæ˜¯å¼€èµ·æ¥é¡¹ç›®æ—¶å€™æ‰å‘ç°çš„è¿™ï¼Œçœ‹æ¥å…³äºåŸç”Ÿ API äººå®¶ Vite ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ï¼Ÿå¯ä»¥æˆ‘æ²¡æœ‰è¯æ®(æºç è¿˜æ²¡çœ‹å®Œ)ï¼Œä¸è¿‡è¿™ç¡®å®ä¸æ˜¯æˆ‘å¹²çš„ ğŸ˜‚

- å¥½äº†ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥ç”¨äº†ï¼›å†æƒ³æƒ³ä¸Šé¢çš„å…³äº Rollup çš„é…ç½®å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥é›†æˆåˆ° `vitejs-plugin-electron` ä¸­çš„ï¼Œè¿™æ ·ä¼šä½¿ `vite.config.ts` æ–‡ä»¶æ›´å°‘ã€æ›´æ¸…æ™°ï¼›å…·ä½“ä»£ç å°±ä¸æ¼”ç¤ºäº†ï¼Œè‡ªå·±æ‹‰ä»£ç çœ‹çœ‹å§ ğŸš€
- [https://github.com/caoxiemeihao/vitejs-plugins/tree/main/electron](https://github.com/caoxiemeihao/vitejs-plugins/tree/main/electron)
